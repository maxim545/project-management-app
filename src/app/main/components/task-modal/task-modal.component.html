<div class="spinner" *ngIf="">
  <mat-progress-bar mode="indeterminate">
  </mat-progress-bar>
</div>
<div class="task-modal">
  <div class="task-modal__content" *ngIf="(task$ | async) as task">
    <!-- --------TITLE-------- -->
    <div class="task-item">
      <div class="task-item__header">
        <mat-icon>subtitles</mat-icon>
        <h2 class="task-item__title" (click)="this.isEditTitleMode = true" *ngIf="!isEditTitleMode">{{task.title}}</h2>
        <form class="title-form" [formGroup]="editTitleForm" name="form" (ngSubmit)="editTaskTitle(task)"
          *ngIf="isEditTitleMode">
          <div class="title-form__field">
            <mat-form-field>
              <input class="title-form__input" formControlName="title" matInput>
              <mat-error *ngIf="title.invalid">
                <div *ngIf="title.errors?.['required']">Title is required</div>
                <div *ngIf="title.errors?.['maxlength']">Max length must be 30</div>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="title-form__btns">
            <button class="btn" [disabled]="!editTitleForm.valid" type="submit">
              <mat-icon class="">check</mat-icon>
            </button>
            <button class="btn" (click)="this.isEditTitleMode = false">
              <mat-icon class="">close</mat-icon>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- --------DESCRIPTION---------->
    <div class="task-item">
      <div class="task-item__header">
        <mat-icon>notes</mat-icon>
        <h2 class="task-item__title">Description</h2>
        <button class="btn task-item__btn" (click)="this.isEditDescrMode = !this.isEditDescrMode">
          <mat-icon class="task-item__icon">edit</mat-icon>
        </button>
      </div>
      <div class="task-item__content">
        <div *ngIf="!isEditDescrMode">
          <p>{{task.description}}</p>
        </div>
        <form class="descr-form" [formGroup]="editDescrForm" name="form" (ngSubmit)="editTaskDescr(task)"
          *ngIf="isEditDescrMode">
          <div class="descr-form__field">
            <mat-form-field>
              <input class="descr-form__input" formControlName="description" matInput>
              <mat-error *ngIf="description.invalid">
                <div *ngIf="description.errors?.['required']">Description is required</div>
                <div *ngIf="description.errors?.['maxlength']">Max length must be 320</div>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="descr-form__btns">
            <button class="btn btn_primary" [disabled]="!editDescrForm.valid" type="submit">
              Save
            </button>
            <button class="btn btn_light" (click)="this.isEditDescrMode = false">
              Close
            </button>
          </div>
        </form>
      </div>
    </div>


    <!-- --------POINTS-------- -->
    <div class="task-item">
      <div class="task-item__header">
        <mat-icon>playlist_add_check</mat-icon>
        <h2 class="task-item__title">Points</h2>
      </div>
      <div class="task-item__content">
        <div class="task-item__points-block" *ngIf="(points$ | async) as points">
          <div class="pogress-bar" *ngIf="(donePoints$ | async) as donePoints">
            <span class="pogress-bar__num">{{getDonePercent(donePoints, points)}}%</span>
            <p-progressBar [value]="getDonePercent(donePoints, points)" [showValue]="false">
            </p-progressBar>
          </div>
          <div *ngFor="let point of points">
            <app-point [task]="task" [boardId]="task.boardId" [point]="point"></app-point>
          </div>
          <div class="task-item__message" *ngIf="!points.length">Not created points for this task</div>
        </div>
        <form class="point-form" [formGroup]="createPointForm" name="form" (ngSubmit)="addPoint(task)"
          *ngIf="isCreateMode">
          <div class="point-form__field">
            <mat-form-field>
              <input class="point-form__input" formControlName="point" matInput>
              <mat-error *ngIf="point.invalid">
                <div *ngIf="point.errors?.['required']">Point name is required</div>
                <div *ngIf="point.errors?.['maxlength']">Max length must be 30</div>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="point-form__btns">
            <button class="btn btn_primary" [disabled]="!createPointForm.valid" type="submit">
              Create
            </button>
            <button class="btn btn_light" (click)="this.isCreateMode = false">
              Cancel
            </button>
          </div>
        </form>
        <button class="btn btn_light" (click)="this.isCreateMode = true" *ngIf="!isCreateMode">Add new point</button>
      </div>
    </div>


    <!-- --------USERS-------- -->
    <div class="task-modal__item item">
      <div class="item__header">
        <h2 class="item__title">Users</h2>
      </div>
      <div class="item__content">
        <div *ngFor="let user of selectedTaskUsers">{{user.login}}</div>
      </div>
    </div>


    <!-- --------FILES-------- -->
    <input type="file" (change)="fileChange($any($event).target.files)" placeholder="Upload file">


    <button class="btn task-modal__btn" (click)="closeTaskModal()">
      <mat-icon>close</mat-icon>
    </button>
  </div>


  <!-- --------SIDEBAR-------- -->

  <div class="task-modal__menu task-menu">
    <div class="task-menu__item task-menu__item_users" *ngIf="(selectedUsers$ | async) as selectedUsers">
      <button class="btn btn_light task-menu__btn" (click)="op.toggle($event)">
        <mat-icon class="icon">person</mat-icon>Users of task
      </button>
      <p-overlayPanel #op [showCloseIcon]="true" [showCloseIcon]="false" [dismissable]="false">
        <p-multiSelect [options]="selectedUsers" [(ngModel)]="users" defaultLabel="Select a User" optionLabel="login"
          display="chip">
        </p-multiSelect>
        <div class="overlay-panel__btns">
          <button class="btn btn_primary overlay-panel__btn" (click)=" addUserForTask(task)">
            <mat-icon class="overlay-panel__icon">person_add</mat-icon>Add user
          </button>
          <button class="btn btn_light overlay-panel__btn" (click)=" op.hide()">
            <mat-icon class="overlay-panel__icon">close</mat-icon>Close
          </button>
        </div>
      </p-overlayPanel>
    </div>
  </div>
</div>
